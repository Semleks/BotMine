<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BotMine - Управление ботом</title>
    <!-- Google Font: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root {
            --bg-color: #1a1b26;
            --surface-color: #24283b;
            --text-color: #c0caf5;
            --border-color: #414868;
            --accent-green: #9ece6a;
            --accent-red: #f7768e;
            --accent-blue: #7aa2f7;
            --accent-gray: #5c6370;
            --accent-orange: #e09f3e;
            --accent-yellow: #ffc107; /* Добавим желтый для кнопки перезапуска */
            --accent-purple: #a78bfa;
            --accent-cyan: #8be9fd;
            --modal-bg: rgba(16, 16, 21, 0.8);
            --shadow-light: rgba(0, 0, 0, 0.2);
            --shadow-medium: rgba(0, 0, 0, 0.35);
            --shadow-heavy: rgba(0, 0, 0, 0.5);
            --doc-keyword: #a78bfa;
            --doc-variable: #9ece6a;
            --doc-string: #f7768e;
            --doc-comment: #5c6370;
            --doc-json-key: #7aa2f7;
            --doc-type: #8be9fd;
            --doc-important: #f7768e;
        }

        body {
            background-color: #000;
            color: var(--text-color);
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            text-align: center;
            /* Prevent text selection during drag */
        }

        body.resizing {
            user-select: none;
        }

        .page {
            display: none;
            width: 100%;
            height: 100vh;
            animation: fadeIn 0.5s ease-out;
        }
        .page.active {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        #bot-selection-page {
            padding: 20px;
        }
        #bot-selection-page h1 {
            font-size: 2.5em;
            font-weight: 600;
            color: #fff;
            margin-bottom: 1rem;
        }
        #bot-selection-page h2 {
            font-size: 1.5em;
            font-weight: 400;
            color: var(--accent-gray);
            margin-bottom: 3rem;
        }
        .bot-list {
            display: flex;
            justify-content: center;
            gap: 2rem;
        }
        .bot-card {
            background: #111;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 2rem;
            min-width: 300px;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
            text-align: left;
            position: relative;
        }
        .bot-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5);
            border-color: var(--accent-blue);
        }
        .bot-card .status-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            transition: background-color 0.3s ease;
        }
        .bot-card .status-indicator.online {
            background-color: var(--accent-green);
            box-shadow: 0 0 10px var(--accent-green);
        }
        .bot-card .status-indicator.offline {
            background-color: var(--accent-gray);
        }
        .bot-card .bot-nick {
            font-size: 1.8em;
            font-weight: 600;
            color: #fff;
            margin: 0 0 5px 0;
        }
        .bot-card .bot-ip {
            font-size: 1em;
            color: var(--accent-gray);
            margin: 0;
        }
        #create-first-bot-btn {
            background-color: var(--accent-blue);
            font-size: 1.2em;
            padding: 15px 30px;
            display: none;
        }

        #bot-management-page {
            max-width: 1200px;
            width: 100%;
            height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }
        .management-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 0 1rem;
            margin-bottom: 1.5rem;
            box-sizing: border-box;
        }
        .management-header .back-btn {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            font-size: 1em;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .management-header .back-btn:hover {
            background-color: var(--border-color);
            color: #fff;
        }
        .management-nav {
            display: flex;
            gap: 10px;
            background-color: var(--surface-color);
            padding: 8px;
            border-radius: 10px;
        }
        .management-nav .nav-btn {
            background: transparent;
            border: none;
            color: var(--text-color);
            padding: 10px 20px;
            font-size: 1em;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .management-nav .nav-btn.active,
        .management-nav .nav-btn:hover {
            background-color: var(--accent-blue);
            color: #fff;
        }
        .container {
            width: 100%;
            height: calc(100vh - 120px);
            background-color: var(--surface-color);
            border-radius: 12px;
            box-shadow: 0 10px 30px var(--shadow-heavy);
            padding: 30px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-sizing: border-box;
        }
        .tab-content {
            display: none;
            height: 100%;
            overflow-y: auto;
            text-align: left;
        }
        .tab-content.active { display: block; }
        .tab-content::-webkit-scrollbar { width: 8px; }
        .tab-content::-webkit-scrollbar-track { background: var(--bg-color); border-radius: 10px; }
        .tab-content::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 10px; }
        .tab-content::-webkit-scrollbar-thumb:hover { background: var(--accent-gray); }
        #main {
            display: flex;
            flex-direction: column;
            gap: 20px;
            height: 100%;
        }

        h1, h2, h3, h4 {
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            color: white;
            font-weight: 500;
            margin: 0 0 20px 0;
        }
        h3 {
            margin-top: 15px;
        }

        button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            margin: 5px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.2s ease;
            box-shadow: 0 4px 10px var(--shadow-light);
        }
        button i { margin-right: 8px; }
        button:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 6px 15px var(--shadow-medium); }
        button:active:not(:disabled) { transform: translateY(0); box-shadow: 0 2px 5px var(--shadow-light); }
        button:disabled { cursor: not-allowed; opacity: 0.6; box-shadow: none; }

        #startBot { background-color: var(--accent-green); }
        #stopBot { background-color: var(--accent-red); }
        #restartBot { background-color: var(--accent-yellow); color: #1a1b26; } /* Стиль для кнопки перезапуска */
        #openModalBtn { background-color: var(--accent-blue); }
        #sendMessage { background-color: var(--accent-gray); }
        #exportBotDataBtn { background-color: var(--accent-orange); }
        #importBotDataBtn { background-color: var(--accent-purple); }
        #whatsNewBtn { background-color: var(--accent-cyan); }
        #createBotBtn, #saveSettingsBtn { background-color: var(--accent-green); width: calc(100% - 10px); }

        input[type="text"], input[type="password"] {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            width: calc(100% - 24px);
            font-size: 15px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        input:focus { outline: none; border-color: var(--accent-blue); box-shadow: 0 0 0 3px rgba(122, 162, 247, 0.3); }

        .controls-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        /* --- СТИЛИ ДЛЯ ШАПКИ КОНСОЛИ --- */
        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 0; /* Убираем нижний отступ у h2 */
        }
        .chat-header h2 {
            border-bottom: none; /* Убираем дублирующуюся линию */
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .status-indicator-console {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1em;
            font-weight: 500;
        }
        .status-indicator-console .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            transition: background-color 0.3s ease;
        }
        .status-indicator-console.online .dot {
            background-color: var(--accent-green);
            animation: pulse 2s infinite;
        }
        .status-indicator-console.online .text {
            color: var(--accent-green);
        }
        .status-indicator-console.offline .dot {
            background-color: var(--accent-red);
        }
        .status-indicator-console.offline .text {
            color: var(--accent-red);
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(158, 206, 106, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(158, 206, 106, 0); }
            100% { box-shadow: 0 0 0 0 rgba(158, 206, 106, 0); }
        }
        /* --- КОНЕЦ СТИЛЕЙ --- */

        #logs {
            background: var(--bg-color);
            color: var(--text-color);
            padding: 18px;
            height: 250px; /* Начальная высота */
            min-height: 60px; /* Минимальная высота */
            flex-shrink: 0; /* Предотвращаем сжатие flex-контейнером */
            overflow-y: auto;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            font-family: 'Fira Code', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            box-shadow: inset 0 2px 8px var(--shadow-light);
            word-break: break-all;
        }

        /* --- НОВЫЕ УЛУЧШЕННЫЕ СТИЛИ ДЛЯ РЕСАЙЗЕРА --- */
        .resizer {
            width: 100%;
            height: 12px; /* Увеличена область для захвата */
            background: transparent;
            cursor: row-resize;
            position: relative;
            margin-top: -10px; /* Небольшое наложение для лучшего вида */
            margin-bottom: 10px;
        }
        .resizer::after {
            content: '';
            position: absolute;
            top: 5px; /* Позиционируем линию по центру */
            left: 40%;
            right: 40%;
            height: 4px;
            background-color: var(--border-color);
            border-radius: 2px;
            transition: background-color 0.2s ease;
        }
        .resizer:hover::after {
            background-color: var(--accent-blue);
        }
        /* --- КОНЕЦ СТИЛЕЙ РЕСАЙЗЕРА --- */

        #logs::-webkit-scrollbar { width: 8px; }
        #logs::-webkit-scrollbar-track { background: var(--bg-color); border-radius: 10px; }
        #logs::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 10px; }
        #logs::-webkit-scrollbar-thumb:hover { background: var(--accent-gray); }

        .log-status { color: var(--accent-blue); }
        .log-info { color: var(--accent-green); }
        .log-error { color: var(--accent-red); font-weight: 600; }
        .log-chat { color: var(--text-color); }

        .message-input-container {
            display: flex;
            gap: 10px;
        }
        .message-input-container input {
            flex-grow: 1;
            margin: 0;
            width: auto;
        }
        .message-input-container button {
            margin: 0;
            flex-shrink: 0;
        }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: var(--modal-bg); backdrop-filter: blur(8px); animation: modalFadeIn 0.3s ease-out; }
        .modal-content { background-color: var(--surface-color); margin: 10% auto; padding: 30px; border: 1px solid var(--border-color); width: 90%; max-width: 500px; border-radius: 15px; position: relative; box-shadow: 0 10px 25px var(--shadow-heavy); animation: modalSlideIn 0.3s ease-out; }
        @keyframes modalFadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes modalSlideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .close { color: var(--border-color); position: absolute; top: 15px; right: 20px; font-size: 32px; font-weight: normal; cursor: pointer; transition: color 0.2s ease, transform 0.2s ease; }
        .close:hover { color: var(--accent-red); transform: rotate(90deg); }

        .plugins-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 25px; margin-top: 20px; }
        .plugin-card { background-color: var(--bg-color); border-radius: 12px; padding: 25px; border: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 12px; transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease; position: relative; box-shadow: 0 5px 15px var(--shadow-light); }
        .plugin-card:hover { transform: translateY(-8px); box-shadow: 0 12px 25px var(--shadow-medium); border-color: var(--accent-blue); }
        .plugin-card.active { border-left: 5px solid var(--accent-green); background-color: #2a3044; }
        .plugin-card h4 { margin: 0 0 5px 0; color: white; border-bottom: none; padding-bottom: 0; font-size: 1.2em; }
        .plugin-card p { margin: 0; font-size: 14px; flex-grow: 1; line-height: 1.6; color: #a9b1d6; }
        .plugin-toggle-btn { width: calc(100% - 10px); margin-left: 0; margin-right: 0; align-self: center; }
        .plugin-toggle-btn.load { background-color: var(--accent-green); }
        .plugin-toggle-btn.remove { background-color: var(--accent-red); }
        .plugin-settings-btn { position: absolute; top: 15px; right: 15px; font-size: 20px; color: var(--border-color); cursor: pointer; transition: color 0.2s, transform 0.2s; display: none; }
        .plugin-settings-btn:hover { color: var(--accent-blue); transform: rotate(90deg); }
        .plugin-card.active .plugin-settings-btn { display: block; }
        .settings-field { display: flex; flex-direction: column; margin-bottom: 10px; text-align: left; }
        .settings-field label { margin-bottom: 5px; font-size: 14px; color: #a9b1d6; font-weight: 500; }

        #whatsNewModal .modal-content { max-width: 600px; height: 70vh; }
        #whatsNewCommits { overflow-y: auto; padding-right: 10px; flex-grow: 1; margin-top: 15px; border-top: 1px solid var(--border-color); padding-top: 15px; text-align: left;}
        .commit-item { background-color: var(--bg-color); padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid var(--accent-cyan); text-align: left;}

        #pluginDocModal .modal-content { max-width: 700px; height: 80vh; overflow-y: auto; text-align: left; }
        .documentation-content code, .documentation-content pre { font-family: 'Fira Code', 'Courier New', Courier, monospace; background-color: var(--bg-color); border-radius: 6px; padding: 2px 6px; font-size: 0.95em; text-align: left; }
        .documentation-content pre { padding: 15px; overflow-x: auto; border: 1px solid var(--border-color); margin: 15px 0; }
    </style>
</head>
<body>

<!-- ЭКРАН 1: ВЫБОР БОТА -->
<div id="bot-selection-page" class="page active">
    <h1>BotMine</h1>
    <h2>Создай бота без знаний программирования</h2>
    <div class="bot-list">
        <div class="bot-card" id="main-bot-card">
            <div class="status-indicator offline" id="bot-status-indicator"></div>
            <h3 class="bot-nick" id="bot-card-nick">Бот не настроен</h3>
            <p class="bot-ip" id="bot-card-server">Нажмите, чтобы управлять</p>
        </div>
    </div>
    <button id="create-first-bot-btn"><i class="fa-solid fa-plus"></i> Создать бота</button>
</div>

<!-- ЭКРАН 2: УПРАВЛЕНИЕ БОТОМ -->
<div id="bot-management-page" class="page">
    <header class="management-header">
        <button id="back-to-selection" class="back-btn"><i class="fa-solid fa-arrow-left"></i> Назад</button>
        <nav class="management-nav">
            <button class="nav-btn active" data-tab="main"><i class="fa-solid fa-terminal"></i> Главный</button>
            <button class="nav-btn" data-tab="plugins"><i class="fa-solid fa-puzzle-piece"></i> Плагины</button>
        </nav>
    </header>

    <div class="container">
        <!-- ВКЛАДКА "ГЛАВНЫЙ" -->
        <div id="main" class="tab-content active">
            <div class="chat-header">
                <h2><i class="fa-solid fa-comments"></i> Игровой чат</h2>
                <div id="bot-console-status" class="status-indicator-console offline">
                    <span class="dot"></span>
                    <span class="text">Stopped</span>
                </div>
            </div>
            <div id="logs"></div>
            <div class="resizer" id="dragHandle"></div>
            <div class="message-input-container">
                <input id="message" type="text" placeholder="Введите сообщение..." disabled>
                <button id="sendMessage" disabled><i class="fa-solid fa-paper-plane"></i> Отправить</button>
            </div>
            <h3>Управление ботом</h3>
            <div class="controls-grid">
                <button id="startBot"><i class="fa-solid fa-play"></i> Запустить</button>
                <button id="stopBot" disabled><i class="fa-solid fa-stop"></i> Выключить</button>
                <button id="restartBot" disabled><i class="fa-solid fa-arrows-rotate"></i> Перезапустить</button>
                <button id="openModalBtn"><i class="fa-solid fa-pencil"></i> Изменить данные</button>
                <button id="exportBotDataBtn"><i class="fa-solid fa-download"></i> Экспорт</button>
                <input type="file" id="importFileInput" accept=".json" style="display: none;">
                <button id="importBotDataBtn"><i class="fa-solid fa-upload"></i> Импорт</button>
                <button id="whatsNewBtn"><i class="fa-solid fa-sparkles"></i> Что нового?</button>
            </div>
        </div>

        <!-- ВКЛАДКА "ПЛАГИНЫ" -->
        <div id="plugins" class="tab-content">
            <h3>Доступные плагины</h3>
            <div class="plugins-grid"></div>
            <hr style="border-color: var(--border-color); margin: 30px 0;">
            <h3>Управление своими плагинами</h3>
            <div class="controls-grid" style="justify-content: center; margin-top: 15px;">
                <button id="addMyPluginBtn" style="background-color: var(--accent-purple);"><i class="fa-solid fa-plus-circle"></i> Добавить свой плагин</button>
                <button id="howToCreatePluginBtn" style="background-color: var(--accent-orange);"><i class="fa-solid fa-book"></i> Как создать свой плагин?</button>
            </div>
            <input type="file" id="pluginZipInput" accept=".zip" style="display: none;">
        </div>
    </div>
</div>

<!-- Модальные окна -->
<div id="botModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Создание / Изменение бота</h2>
        <input type="text" id="modal_username" placeholder="Имя пользователя (username)">
        <input type="password" id="modal_password" placeholder="Пароль (необязательно)">
        <input type="text" id="modal_server" placeholder="Адрес сервера (host)">
        <button id="createBotBtn"><i class="fa-solid fa-save"></i> Сохранить</button>
    </div>
</div>
<div id="settingsModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2 id="settingsModalTitle">Настройки плагина</h2>
        <div id="settingsModalBody"></div>
        <button id="saveSettingsBtn"><i class="fa-solid fa-floppy-disk"></i> Сохранить</button>
    </div>
</div>
<div id="whatsNewModal" class="modal">
    <div class="modal-content">
        <span class="close" id="closeWhatsNewModal">&times;</span>
        <h2><i class="fa-solid fa-sparkles"></i> Что нового в BotMine?</h2>
        <div id="whatsNewCommits"><p class="loading-text">Загрузка последних обновлений...</p></div>
    </div>
</div>
<div id="pluginDocModal" class="modal">
    <div class="modal-content">
        <span class="close" id="closePluginDocModal">&times;</span>
        <h2><i class="fa-solid fa-book"></i> Как создать свой плагин?</h2>
        <div class="documentation-content">
            <p>Привет, разработчик! Эта документация поможет быстро и легко сделать твой собственный плагин.</p>
            <p>Структура плагина должна быть такой:</p>
            <pre><code>
<span class="doc-keyword">class</span> <span class="doc-variable">NamePlugin</span> {
    <span class="doc-keyword">constructor</span>(<span class="doc-variable">bot</span>, <span class="doc-variable">botInfo</span>, <span class="doc-variable">botAPI</span>) {
        <span class="doc-keyword">this</span>.<span class="doc-variable">botInfo</span> = <span class="doc-variable">botInfo</span>;
        <span class="doc-keyword">this</span>.<span class="doc-variable">botAPI</span> = <span class="doc-variable">botAPI</span>;
        <span class="doc-keyword">this</span>.<span class="doc-variable">bot</span> = <span class="doc-variable">bot</span>;
        <span class="doc-variable">console</span>.<span class="doc-variable">log</span>(<span class="doc-string">'[NamePlugin] Плагин загружен.'</span>);
    }

    <span class="doc-variable">onMessage</span>(<span class="doc-variable">message</span>, <span class="doc-variable">json</span>) {
        <span class="doc-comment">// Твой код здесь</span>
    }
}

<span class="doc-keyword">module</span>.<span class="doc-variable">exports</span> = <span class="doc-variable">NamePlugin</span>;
            </code></pre>

            <h3>Давай разберемся</h3>
            <p>В методе <span class="doc-variable"><code>onMessage</code></span> тебе будет даваться текст из чата (который видит бот).</p>
            <p>Пример: <code>› Игрок Владелец Dream123067 зашел на сервер.</code></p>
            <p>Этот текст хранится в переменной <span class="doc-variable"><code>message</code></span>. Также у тебя есть <span class="doc-variable"><code>this.botAPI</code></span>. Там все самое нужное:</p>

            <p><span class="doc-variable"><code>this.botAPI.sendMessage()</code></span> – этот метод позволяет тебе отправить сообщение в чат. У него есть параметры: <span class="doc-variable"><code>bot</code></span>, <span class="doc-variable"><code>type</code></span>, <span class="doc-variable"><code>text</code></span>, <span class="doc-variable"><code>nick</code></span>. Пример использования:</p>
            <pre><code><span class="doc-variable">this</span>.<span class="doc-variable">botAPI</span>.<span class="doc-variable">sendMessage</span>(<span class="doc-variable">this</span>.<span class="doc-variable">bot</span>, <span class="doc-string">'clan'</span>, <span class="doc-string">"Привет!"</span>);</code></pre>
            <p>Этот код напишет в клановый чат "Привет!". Типы чатов:</p>
            <ul>
                <li><span class="doc-type"><code>global</code></span> - глобальный</li>
                <li><span class="doc-type"><code>local</code></span> - локальный</li>
                <li><span class="doc-type"><code>private</code></span> - приватный</li>
                <li><span class="doc-type"><code>cmd</code></span> - команда (отправить команду в консоль бота)</li>
                <li><span class="doc-type"><code>clan</code></span> - клановый</li>
            </ul>
            <p>Если используешь <span class="doc-type"><code>private</code></span> - обязательно после сообщения добавь ник игрока. Пример:</p>
            <pre><code><span class="doc-variable">this</span>.<span class="doc-variable">botAPI</span>.<span class="doc-variable">sendMessage</span>(<span class="doc-variable">this</span>.<span class="doc-variable">bot</span>, <span class="doc-string">'private'</span>, <span class="doc-string">"Как дела?"</span>, <span class="doc-variable">nick</span>);</code></pre>

            <h3>Как получить ник игрока?</h3>
            <p>Используй <span class="doc-variable"><code>botAPI</code></span>!</p>
            <pre><code><span class="doc-variable">this</span>.<span class="doc-variable">botAPI</span>.<span class="doc-variable">getNick</span>(<span class="doc-variable">text</span>, <span class="doc-variable">json</span>); <span class="doc-comment">// Вернет настоящий ник игрока</span></code></pre>

            <h3>Как получить Тип чата?</h3>
            <pre><code><span class="doc-variable">this</span>.<span class="doc-variable">botAPI</span>.<span class="doc-variable">getType</span>(<span class="doc-variable">text</span>);</code></pre>

            <h3>Как получить Текст?</h3>
            <p>Убирает префиксы (например, <code>[G] Semleks Dream123067 -> ТЕСТ</code> дает: <code>ТЕСТ</code>).</p>
            <pre><code><span class="doc-variable">this</span>.<span class="doc-variable">botAPI</span>.<span class="doc-variable">getText</span>(<span class="doc-variable">text</span>);</code></pre>

            <h3>Манифест плагина</h3>
            <p>У каждого плагина <span class="doc-important">ДОЛЖЕН ОБЯЗАТЕЛЬНО</span> быть манифест! Он выглядит так:</p>
            <pre><code>
{
  <span class="doc-json-key">"name"</span>: <span class="doc-string">"Name"</span>,
  <span class="doc-json-key">"description"</span>: <span class="doc-string">"Что делает плагин"</span>,
  <span class="doc-json-key">"defaultSettings"</span>: {
    <span class="doc-json-key">"message"</span>: {
      <span class="doc-json-key">"label"</span>: <span class="doc-string">"Напиши .."</span>,
      <span class="doc-json-key">"value"</span>: <span class="doc-string">""</span>
    }
  }
}
            </code></pre>
            <ul>
                <li><span class="doc-json-key"><code>name</code></span> - название плагина.</li>
                <li><span class="doc-json-key"><code>description</code></span> - описание.</li>
                <li><span class="doc-json-key"><code>message</code></span> - название подкатегории, что должен ввести пользователь (это можно изменить на любое другое имя, например, "greetingText").</li>
                <li><span class="doc-json-key"><code>label</code></span> - это название поля, которое отобразится на сайте (например, "Типа введите сообщение").</li>
                <li><span class="doc-json-key"><code>value</code></span> - будет значение, введенное пользователем.</li>
            </ul>

            <h3>Как использовать ввод пользователя (настройки плагина)?</h3>
            <pre><code><span class="doc-variable">this</span>.<span class="doc-variable">botInfo</span>.<span class="doc-variable">pluginSettings</span>.<span class="doc-variable">Hi</span>?.<span class="doc-variable">message</span>?.<span class="doc-variable">value</span></code></pre>
            <p>Вместо <span class="doc-variable"><code>Hi</code></span> подставьте <span class="doc-important">название вашего плагина</span> (как указано в поле <span class="doc-json-key"><code>"name"</code></span> из <span class="doc-variable"><code>manifest.json</code></span>).</p>
            <p>Вместо <span class="doc-variable"><code>message</code></span> подставьте <span class="doc-important">название вашей подкатегории</span> из <span class="doc-json-key"><code>"defaultSettings"</code></span> (например, "greetingText").</p>

            <p>Чтобы загрузить плагин, необходимо создать <span class="doc-important">ZIP-архив</span>. Внутри архива может быть сколько угодно файлов, но <span class="doc-important">ОБЯЗАТЕЛЬНЫМИ</span> должны быть два файла в корне архива:</p>
            <ul>
                <li><span class="doc-important"><code>index.js</code></span> - главный файл плагина с вашей логикой.</li>
                <li><span class="doc-important"><code>manifest.json</code></span> - файл с метаданными и настройками плагина.</li>
            </ul>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {

        let ws;
        let botData = { nick: "", server: "", activatedPlugins: [], pluginSettings: {}, botIsRunning: false };
        let availablePlugins = {};
        let messageBuffer = "";

        const logsDiv = document.getElementById("logs");
        const botModal = document.getElementById("botModal");
        const settingsModal = document.getElementById("settingsModal");
        const whatsNewModal = document.getElementById("whatsNewModal");
        const pluginDocModal = document.getElementById("pluginDocModal");
        const startBotBtn = document.getElementById("startBot");
        const stopBotBtn = document.getElementById("stopBot");
        const restartBotBtn = document.getElementById("restartBot");
        const messageInput = document.getElementById("message");
        const sendMessageBtn = document.getElementById("sendMessage");
        const openBotModalBtn = document.getElementById("openModalBtn");
        const exportBotDataBtn = document.getElementById("exportBotDataBtn");
        const importBotDataBtn = document.getElementById("importBotDataBtn");
        const importFileInput = document.getElementById("importFileInput");
        const whatsNewBtn = document.getElementById("whatsNewBtn");
        const botSelectionPage = document.getElementById('bot-selection-page');
        const botManagementPage = document.getElementById('bot-management-page');
        const mainBotCard = document.getElementById('main-bot-card');
        const backToSelectionBtn = document.getElementById('back-to-selection');
        const managementNav = document.querySelector('.management-nav');
        const createFirstBotBtn = document.getElementById('create-first-bot-btn');
        const botList = document.querySelector('.bot-list');
        const addMyPluginBtn = document.getElementById("addMyPluginBtn");
        const howToCreatePluginBtn = document.getElementById("howToCreatePluginBtn");
        const pluginZipInput = document.getElementById("pluginZipInput");
        const botConsoleStatus = document.getElementById("bot-console-status");


        // --- УЛУЧШЕННЫЙ КОД ДЛЯ ИЗМЕНЕНИЯ РАЗМЕРА КОНСОЛИ ---
        const dragHandle = document.getElementById('dragHandle');

        dragHandle.addEventListener('mousedown', function(e) {
            e.preventDefault(); // Предотвращаем стандартное поведение (например, выделение текста)

            const startY = e.clientY;
            const startHeight = logsDiv.offsetHeight;

            document.body.classList.add('resizing');

            function doDrag(e) {
                const newHeight = startHeight + e.clientY - startY;
                // Устанавливаем минимальную высоту, но не ограничиваем максимальную
                logsDiv.style.height = `${Math.max(60, newHeight)}px`;
            }

            function stopDrag() {
                document.removeEventListener('mousemove', doDrag);
                document.removeEventListener('mouseup', stopDrag);
                document.body.classList.remove('resizing');
            }

            document.addEventListener('mousemove', doDrag);
            document.addEventListener('mouseup', stopDrag);
        });
        // --- КОНЕЦ КОДА ДЛЯ ИЗМЕНЕНИЯ РАЗМЕРА ---

        mainBotCard.addEventListener('click', () => {
            botSelectionPage.classList.remove('active');
            botManagementPage.classList.add('active');
        });
        backToSelectionBtn.addEventListener('click', () => {
            botManagementPage.classList.remove('active');
            botSelectionPage.classList.add('active');
        });
        managementNav.addEventListener('click', (e) => {
            const target = e.target.closest('.nav-btn');
            if (target) openTab(target, target.dataset.tab);
        });

        function openTab(clickedBtn, tabName) {
            document.querySelectorAll(".tab-content").forEach(tab => tab.classList.remove("active"));
            document.querySelectorAll(".nav-btn").forEach(btn => btn.classList.remove("active"));
            document.getElementById(tabName).classList.add("active");
            clickedBtn.classList.add("active");
        }

        function connect() {
            if (ws && ws.readyState === WebSocket.OPEN) return;
            ws = new WebSocket("ws://localhost:3001");

            ws.onopen = () => {
                logWithType("status", "WebSocket подключен.");
                messageBuffer = "";
            };

            ws.onmessage = (event) => {
                messageBuffer += event.data;
                processMessageBuffer();
            };

            ws.onclose = () => {
                logWithType("status", "WebSocket закрыт. Попытка переподключения через 3с...");
                botData.botIsRunning = false;
                updateUI();
                setTimeout(connect, 3000);
            };

            ws.onerror = () => {
                logWithType("error", "Ошибка WebSocket.");
                botData.botIsRunning = false;
                updateUI();
            };
        }

        function processMessageBuffer() {
            let lastCut = 0;
            while (lastCut < messageBuffer.length) {
                const firstBrace = messageBuffer.indexOf('{', lastCut);
                if (firstBrace === -1) break;

                let braceCount = 0;
                let endBrace = -1;
                for (let i = firstBrace; i < messageBuffer.length; i++) {
                    if (messageBuffer[i] === '{') braceCount++;
                    if (messageBuffer[i] === '}') braceCount--;
                    if (braceCount === 0) {
                        endBrace = i;
                        break;
                    }
                }

                if (endBrace !== -1) {
                    const chunk = messageBuffer.substring(firstBrace, endBrace + 1);
                    try {
                        const data = JSON.parse(chunk);
                        handleWsData(data);
                        lastCut = endBrace + 1;
                    } catch (e) {
                        // Failed to parse, maybe incomplete, wait for more data.
                        break;
                    }
                } else {
                    // Incomplete object, wait for more data.
                    break;
                }
            }
            if (lastCut > 0) {
                messageBuffer = messageBuffer.substring(lastCut);
            }
        }

        function handleWsData(data) {
            if (data.type === "botInfo") {
                botData = { ...botData, ...data.data };
                updateUI();
            } else if (data.type === "availablePlugins") {
                availablePlugins = data.data;
                renderPlugins(availablePlugins);
            } else if (data.type === "chat") {
                logWithType("chat", data.message);
            } else if (data.type === "status") {
                logWithType(data.message.includes("Ошибка") ? "error" : "status", data.message);
            } else if (data.type === "pluginUploadStatus") {
                logWithType(data.success ? "info" : "error", data.message);
            }
        }

        function updateUI() {
            const botExists = botData.nick && botData.server;
            createFirstBotBtn.style.display = botExists ? 'none' : 'inline-flex';
            botList.style.display = botExists ? 'flex' : 'none';

            if (botExists) {
                document.getElementById('bot-card-nick').textContent = botData.nick;
                document.getElementById('bot-card-server').textContent = botData.server;
                const statusIndicator = document.getElementById('bot-status-indicator');
                statusIndicator.classList.toggle('online', botData.botIsRunning);
                statusIndicator.classList.toggle('offline', !botData.botIsRunning);
            }

            // Обновление индикатора в консоли
            botConsoleStatus.classList.toggle('online', botData.botIsRunning);
            botConsoleStatus.classList.toggle('offline', !botData.botIsRunning);
            botConsoleStatus.querySelector('.text').textContent = botData.botIsRunning ? 'Running' : 'Stopped';

            startBotBtn.disabled = botData.botIsRunning;
            stopBotBtn.disabled = !botData.botIsRunning;
            restartBotBtn.disabled = !botData.botIsRunning;
            messageInput.disabled = !botData.botIsRunning;
            sendMessageBtn.disabled = !botData.botIsRunning;
            updatePluginButtons();
        }

        function logWithType(type, msg) {
            const span = document.createElement('span');
            span.className = `log-${type}`;
            span.innerHTML = msg.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            logsDiv.appendChild(span);
            logsDiv.innerHTML += "<br>";
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        function renderPlugins(plugins) {
            const container = document.querySelector('.plugins-grid');
            if (!container) return;
            container.innerHTML = '';
            for (const pluginName in plugins) {
                const plugin = plugins[pluginName];
                container.insertAdjacentHTML('beforeend', `
                    <div class="plugin-card" data-plugin-name="${plugin.name}">
                        <i class="fa-solid fa-gear plugin-settings-btn"></i>
                        <h4>${plugin.name}</h4>
                        <p>${plugin.description}</p>
                        <button class="plugin-toggle-btn"></button>
                    </div>`);
            }
            updatePluginButtons();
        }

        function updatePluginButtons() {
            document.querySelectorAll('.plugin-card').forEach(card => {
                const pluginName = card.dataset.pluginName;
                const button = card.querySelector('.plugin-toggle-btn');
                const isActive = botData.activatedPlugins.includes(pluginName);
                button.innerHTML = isActive ? '<i class="fa-solid fa-trash"></i> Удалить' : '<i class="fa-solid fa-plus"></i> Загрузить';
                button.className = `plugin-toggle-btn ${isActive ? 'remove' : 'load'}`;
                card.classList.toggle('active', isActive);
            });
        }

        function sendWsMessage(type, payload = {}) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                logWithType("error", "WebSocket не подключен.");
                connect();
                return;
            }
            ws.send(JSON.stringify({ type, ...payload }));
        }

        startBotBtn.onclick = () => sendWsMessage('startBot');
        stopBotBtn.onclick = () => sendWsMessage('stopBot');
        restartBotBtn.onclick = () => {
            logWithType("status", "Перезапускаю бота...");
            sendWsMessage('stopBot');
            setTimeout(() => {
                sendWsMessage('startBot');
            }, 1500); // Задержка в 1.5 секунды
        };

        sendMessageBtn.onclick = () => {
            if (messageInput.value.trim()) {
                sendWsMessage('sendMessage', { message: messageInput.value });
                messageInput.value = "";
            }
        };
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !messageInput.disabled) {
                e.preventDefault();
                sendMessageBtn.click();
            }
        });

        document.getElementById("createBotBtn").onclick = () => {
            sendWsMessage('createBot', {
                host: document.getElementById("modal_server").value,
                username: document.getElementById("modal_username").value,
                password: document.getElementById("modal_password").value
            });
            botModal.style.display = "none";
        };

        openBotModalBtn.onclick = () => {
            document.getElementById('modal_username').value = botData.nick || "";
            document.getElementById('modal_server').value = botData.server || "";
            document.getElementById('modal_password').value = "";
            botModal.style.display = "block";
        };

        createFirstBotBtn.onclick = () => openBotModalBtn.click();

        document.querySelector('.plugins-grid').addEventListener('click', (e) => {
            const card = e.target.closest('.plugin-card');
            if (!card) return;
            const pluginName = card.dataset.pluginName;
            if (e.target.classList.contains('plugin-toggle-btn')) {
                sendWsMessage('togglePlugin', { pluginName });
            }
            if (e.target.classList.contains('plugin-settings-btn')) {
                openSettingsModal(pluginName);
            }
        });

        function openSettingsModal(pluginName) {
            const settings = botData.pluginSettings?.[pluginName] || availablePlugins[pluginName]?.defaultSettings;
            document.getElementById('settingsModalTitle').textContent = `Настройки: ${pluginName}`;
            const modalBody = document.getElementById('settingsModalBody');
            modalBody.innerHTML = '';

            if (settings && Object.keys(settings).length > 0) {
                for (const key in settings) {
                    modalBody.innerHTML += `<div class="settings-field"><label for="setting_${key}">${settings[key].label}</label><input type="text" id="setting_${key}" name="${key}" value="${settings[key].value || ''}"></div>`;
                }
                document.getElementById('saveSettingsBtn').style.display = 'flex';
            } else {
                modalBody.innerHTML = '<p>Для этого плагина нет доступных настроек.</p>';
                document.getElementById('saveSettingsBtn').style.display = 'none';
            }
            document.getElementById('saveSettingsBtn').onclick = () => savePluginSettings(pluginName);
            settingsModal.style.display = "block";
        }

        function savePluginSettings(pluginName) {
            const newSettings = {};
            document.querySelectorAll('#settingsModalBody input').forEach(input => {
                newSettings[input.name] = input.value;
            });
            sendWsMessage('savePluginSettings', { pluginName, settings: newSettings });
            settingsModal.style.display = "none";
        }

        exportBotDataBtn.onclick = async () => {
            logWithType("status", "Экспорт файла main.json...");
            try {
                const response = await fetch('/export-bot-data');
                if (!response.ok) throw new Error(await response.text());
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'main.json';
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
                logWithType("info", "Файл main.json успешно экспортирован.");
            } catch (error) {
                logWithType("error", `Ошибка экспорта: ${error.message}`);
            }
        };

        importBotDataBtn.onclick = () => importFileInput.click();
        importFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file || !file.name.endsWith('.json')) {
                logWithType("error", "Выберите файл в формате JSON.");
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                sendWsMessage('importBotData', { content: e.target.result });
                logWithType("status", "Файл отправлен на сервер для импорта.");
            };
            reader.readAsText(file);
            event.target.value = '';
        });

        addMyPluginBtn.onclick = () => pluginZipInput.click();
        howToCreatePluginBtn.onclick = () => pluginDocModal.style.display = "block";
        pluginZipInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file || !file.name.endsWith('.zip')) {
                logWithType("error", "Выберите файл в формате ZIP.");
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                const binaryString = new Uint8Array(e.target.result).reduce((data, byte) => data + String.fromCharCode(byte), '');
                const base64Content = btoa(binaryString);
                sendWsMessage('uploadPluginZip', { fileName: file.name, content: base64Content });
                logWithType("status", `Отправка плагина "${file.name}"...`);
            };
            reader.readAsArrayBuffer(file);
            event.target.value = '';
        });

        whatsNewBtn.onclick = () => {
            whatsNewModal.style.display = "block";
            fetchCommits();
        };
        async function fetchCommits() {
            const container = document.getElementById("whatsNewCommits");
            container.innerHTML = '<p class="loading-text">Загрузка...</p>';
            try {
                const response = await fetch('/api/commits');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const commits = await response.json();
                container.innerHTML = commits.map(commit => `
                    <div class="commit-item">
                        <p><strong>${commit.message}</strong></p>
                        <p><small>Автор: ${commit.author} | Дата: ${new Date(commit.date).toLocaleDateString('ru-RU')}</small></p>
                    </div>
                `).join('');
            } catch (error) {
                container.innerHTML = `<p class="log-error">Ошибка загрузки: ${error.message}</p>`;
            }
        }

        document.querySelectorAll('.modal .close').forEach(closeBtn => {
            closeBtn.onclick = () => {
                closeBtn.closest('.modal').style.display = 'none';
            }
        });
        window.onclick = (event) => {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        };

        connect();
        updateUI();

    });
</script>
</body>
</html>